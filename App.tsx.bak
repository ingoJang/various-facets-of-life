import React, { useEffect, useRef, useState } from 'react';
import Phaser from 'phaser';
import { gameConfig } from './game/gameConfig';
import { EventBus } from './game/EventBus';
import { Category, EVENTS, GameStats, CATEGORY_ORDER } from './types';
import { Logo } from './components/Logo';
import { LifeBalance } from './components/LifeBalance';
import { BACKGROUND_IMAGE_URL } from './constants';

// Initial state
const INITIAL_STATS: GameStats = {
  [Category.Love]: 0,
  [Category.Passion]: 0,
  [Category.Freedom]: 0,
  [Category.Ambition]: 0,
  [Category.Identity]: 0,
  [Category.Friendship]: 0,
};

const App: React.FC = () => {
  const gameRef = useRef<Phaser.Game | null>(null);
  const [stats, setStats] = useState<GameStats>(INITIAL_STATS);
  const [earnedCategory, setEarnedCategory] = useState<Category | null>(null);
  const [isPaused, setIsPaused] = useState(false);
  const [showInfo, setShowInfo] = useState(false);
  const [debugMode, setDebugMode] = useState(false);
  const [audioEnabled, setAudioEnabled] = useState(true); // Tracking state for UI toggles (logic in Phaser)

  // Initialize Game
  useEffect(() => {
    if (!gameRef.current) {
      gameRef.current = new Phaser.Game(gameConfig);
      
      // Listen for events from Phaser
      EventBus.on(EVENTS.SCORE_UPDATE, (newStats: GameStats) => {
        setStats({ ...newStats });
      });

      EventBus.on(EVENTS.GAME_OVER, (category: Category) => {
        setEarnedCategory(category);
      });
    }

    return () => {
      // Cleanup events if component unmounts (rare in this app structure)
      EventBus.off(EVENTS.SCORE_UPDATE);
      EventBus.off(EVENTS.GAME_OVER);
    };
  }, []);

  // Keyboard Debug Listener
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key.toLowerCase() === 'o') {
        setDebugMode(prev => !prev);
      }
      if (earnedCategory && (e.key === 'Enter' || e.key === ' ')) {
          continueGame();
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [earnedCategory]);

  const continueGame = () => {
    setEarnedCategory(null);
    EventBus.emit(EVENTS.RESUME_GAME);
  };

  const togglePause = () => {
    const newState = !isPaused;
    setIsPaused(newState);
    EventBus.emit(EVENTS.TOGGLE_PAUSE, newState);
  };

  return (
    <div className="relative w-screen h-screen overflow-hidden bg-[#3b82f6] flex items-center justify-center">
      
      {/* Background Image Layer */}
      <img 
        src={BACKGROUND_IMAGE_URL} 
        alt="Background" 
        className="absolute inset-0 w-full h-full object-cover z-0"
        onError={(e) => {
          // Fallback if image fails to load
          e.currentTarget.style.display = 'none';
        }}
      />

      {/* 1. Debug Overlay */}
      {debugMode && (
        <div className="absolute inset-0 z-50 pointer-events-none opacity-40">
           {/* Placeholder text explaining debug mode since we can't load the user's specific local file securely without input */}
           <div className="w-full h-full border-4 border-red-500 flex items-center justify-center text-red-500 text-4xl font-bold bg-white/10">
              DEBUG OVERLAY MODE (Mock Image Placeholder)
           </div>
        </div>
      )}

      {/* 2. Game Container */}
      <div id="game-container" className="absolute inset-0 z-0" />

      {/* 3. UI Layer */}
      <div className="absolute inset-0 z-10 w-full h-full max-w-[1920px] max-h-[1080px] mx-auto pointer-events-none">
        
        {/* Top Left Logo */}
        <Logo />

        {/* Top Right Stats */}
        <LifeBalance stats={stats} />

        {/* Bottom Left Cloud Button (Info) */}
        <button 
          onClick={() => setShowInfo(!showInfo)}
          className="absolute bottom-8 left-12 w-24 h-16 bg-white pointer-events-auto hover:scale-105 transition-transform flex items-center justify-center filter drop-shadow-lg"
          style={{ 
            clipPath: 'polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%)', // Rough cloud shape
            borderRadius: '20px'
          }}
        >
          {/* Dashed border simulation */}
          <div className="absolute inset-1 border-2 border-dashed border-black rounded-[18px]"></div>
          <span className="text-4xl font-serif font-bold italic z-10">i</span>
        </button>

        {/* Bottom Right Cloud Button (Pause) */}
        <button 
          onClick={togglePause}
          className="absolute bottom-8 right-12 w-24 h-16 bg-white pointer-events-auto hover:scale-105 transition-transform flex items-center justify-center filter drop-shadow-lg"
          style={{ 
             clipPath: 'polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%)',
             borderRadius: '20px'
          }}
        >
          <div className="absolute inset-1 border-2 border-dashed border-black rounded-[18px]"></div>
          <span className="text-2xl font-bold z-10 tracking-widest">||</span>
        </button>

      </div>

      {/* 4. Full Screen Overlays (Pause / Info / Earned) */}
      
      {/* Earned Overlay */}
      {earnedCategory && (
        <div 
          onClick={continueGame}
          className="absolute inset-0 z-40 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center cursor-pointer animate-fade-in"
        >
          <div className="bg-white p-12 rounded-3xl shadow-2xl border-4 border-black text-center transform scale-110">
            <h2 className="text-3xl text-gray-600 mb-2 font-bold uppercase">Congratulations</h2>
            <h1 className="text-6xl font-black mb-8 text-black">
              You earned <span className="text-red-600">{earnedCategory}</span>
            </h1>
            <p className="text-xl animate-pulse text-gray-500 font-bold">Press SPACE or Click to continue</p>
          </div>
        </div>
      )}

      {/* Info Overlay */}
      {showInfo && (
        <div className="absolute inset-0 z-30 bg-black/40 backdrop-blur-sm flex items-center justify-center" onClick={() => setShowInfo(false)}>
           <div className="bg-white p-8 rounded-2xl max-w-lg text-center shadow-xl border-2 border-black relative">
              <button className="absolute top-2 right-4 text-2xl font-bold hover:text-red-500">&times;</button>
              <h2 className="text-3xl font-bold mb-4">How to Play</h2>
              <ul className="text-left text-lg space-y-2 mb-6 font-medium">
                <li>• Use <span className="font-bold bg-gray-200 px-2 rounded">A</span> / <span className="font-bold bg-gray-200 px-2 rounded">D</span> or Arrows to move.</li>
                <li>• Catch falling objects to fill the bars.</li>
                <li>• Each object matches a specific life facet.</li>
                <li>• Reach 5/5 in a category to earn it!</li>
              </ul>
              <p className="text-sm text-gray-500">Click anywhere to close</p>
           </div>
        </div>
      )}

      {/* Pause Menu */}
      {isPaused && !earnedCategory && (
        <div className="absolute inset-0 z-30 bg-black/50 backdrop-blur-sm flex items-center justify-center">
          <div className="bg-white w-80 p-6 rounded-xl border-4 border-black shadow-[8px_8px_0_0_rgba(0,0,0,1)] text-center">
            <h2 className="text-4xl font-black mb-8 italic">PAUSED</h2>
            
            <div className="space-y-4">
              <button 
                onClick={togglePause}
                className="w-full py-3 bg-black text-white font-bold text-xl hover:bg-gray-800 transition-colors"
              >
                RESUME
              </button>
              
              <div className="flex justify-between items-center px-2">
                <span className="font-bold text-lg">Music / SFX</span>
                <button 
                  onClick={() => setAudioEnabled(!audioEnabled)} // Placeholder for actual audio mute logic
                  className={`w-12 h-6 rounded-full p-1 transition-colors ${audioEnabled ? 'bg-green-500' : 'bg-gray-300'}`}
                >
                  <div className={`w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform ${audioEnabled ? 'translate-x-6' : 'translate-x-0'}`} />
                </button>
              </div>

              <button 
                onClick={() => {
                   EventBus.emit(EVENTS.RESTART_GAME);
                   setIsPaused(false);
                }}
                className="w-full py-2 border-2 border-red-500 text-red-500 font-bold hover:bg-red-50 transition-colors mt-4"
              >
                RESTART GAME
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
};

export default App;
